#!/usr/bin/env bash
# Pre-commit hook to clean and validate the dbt-airflow-lib project
# This hook runs automatically before each commit to ensure code quality

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}Running pre-commit checks for dbt-airflow-lib...${NC}"

# Find the dbt-airflow-lib project root
# This hook may be called from git root in a monorepo, so we need to find the project
GIT_ROOT="$(git rev-parse --show-toplevel)"

# Check if we're in dbt-airflow-lib subdirectory
if [ -f "$GIT_ROOT/dbt-airflow-lib/pyproject.toml" ] && [ -d "$GIT_ROOT/dbt-airflow-lib/src/dlh_airflow_common" ]; then
    PROJECT_ROOT="$GIT_ROOT/dbt-airflow-lib"
elif [ -f "pyproject.toml" ] && [ -d "src/dlh_airflow_common" ]; then
    PROJECT_ROOT="$(pwd)"
else
    echo -e "${YELLOW}⚠ Skipping pre-commit hook - not a dbt-airflow-lib commit${NC}"
    exit 0
fi

cd "$PROJECT_ROOT"

# Function to check if we're in the right directory
check_project_root() {
    if [ ! -f "pyproject.toml" ] || [ ! -d "src/dlh_airflow_common" ]; then
        echo -e "${RED}Error: Not in dbt-airflow-lib project root${NC}"
        exit 1
    fi
}

# Function to clean build artifacts
clean_artifacts() {
    echo -e "${YELLOW}1. Cleaning build artifacts...${NC}"

    # Remove Python cache
    find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
    find . -type f -name "*.pyc" -delete 2>/dev/null || true
    find . -type f -name "*.pyo" -delete 2>/dev/null || true
    find . -type f -name "*.py~" -delete 2>/dev/null || true

    # Remove pytest cache
    rm -rf .pytest_cache 2>/dev/null || true

    # Remove coverage files
    rm -rf htmlcov 2>/dev/null || true
    rm -f .coverage 2>/dev/null || true
    rm -f coverage.xml 2>/dev/null || true

    # Remove build artifacts
    rm -rf build/ 2>/dev/null || true
    rm -rf dist/ 2>/dev/null || true
    rm -rf *.egg-info 2>/dev/null || true
    rm -rf src/*.egg-info 2>/dev/null || true

    # Remove mypy cache
    rm -rf .mypy_cache 2>/dev/null || true

    # Remove ruff cache
    rm -rf .ruff_cache 2>/dev/null || true

    # Remove tox cache
    rm -rf .tox 2>/dev/null || true

    echo -e "${GREEN}✓ Cleaned build artifacts${NC}"
}

# Function to run code formatting
run_formatting() {
    echo -e "${YELLOW}2. Running code formatters...${NC}"

    # Activate virtual environment if it exists
    if [ -d ".venv" ]; then
        source .venv/bin/activate
    elif [ -d "venv" ]; then
        source venv/bin/activate
    else
        echo -e "${RED}Error: No virtual environment found${NC}"
        exit 1
    fi

    # Run black formatter
    echo "  - Running black..."
    black src/ tests/ --quiet 2>/dev/null || {
        echo -e "${RED}✗ Black formatting failed${NC}"
        exit 1
    }

    # Run ruff to fix auto-fixable issues
    echo "  - Running ruff auto-fixes..."
    ruff check --fix src/ tests/ --quiet 2>/dev/null || true

    echo -e "${GREEN}✓ Code formatting complete${NC}"
}

# Function to run linting
run_linting() {
    echo -e "${YELLOW}3. Running linters...${NC}"

    # Run ruff linting
    echo "  - Running ruff checks..."
    if ! ruff check src/ tests/ ; then
        echo -e "${RED}✗ Ruff linting failed${NC}"
        echo -e "${YELLOW}Tip: Run 'make lint-fix' to auto-fix issues${NC}"
        exit 1
    fi

    echo -e "${GREEN}✓ Linting passed${NC}"
}

# Function to run type checking
run_type_checking() {
    echo -e "${YELLOW}4. Running type checks...${NC}"

    echo "  - Running mypy..."
    if ! mypy src/ > /dev/null 2>&1; then
        echo -e "${RED}✗ Type checking failed${NC}"
        mypy src/  # Show the actual errors
        exit 1
    fi

    echo -e "${GREEN}✓ Type checking passed${NC}"
}

# Function to run tests
run_tests() {
    echo -e "${YELLOW}5. Running unit tests...${NC}"

    # Run only unit tests (skip integration tests for speed)
    if ! pytest -q --tb=short 2>/dev/null; then
        echo -e "${RED}✗ Tests failed${NC}"
        exit 1
    fi

    echo -e "${GREEN}✓ All tests passed${NC}"
}

# Function to validate YAML fixtures
validate_yaml() {
    echo -e "${YELLOW}6. Validating YAML fixtures...${NC}"

    # Check if validate-dags command exists
    if command -v validate-dags &> /dev/null; then
        if [ -d "tests/integration/fixtures/dag_factory" ]; then
            echo "  - Validating dag-factory fixtures..."
            if ! validate-dags tests/integration/fixtures/dag_factory/ --quiet 2>/dev/null; then
                echo -e "${YELLOW}⚠ YAML validation warnings (non-blocking)${NC}"
            fi
        fi
    fi

    echo -e "${GREEN}✓ YAML validation complete${NC}"
}

# Main execution
main() {
    # Check if any dbt-airflow-lib files are being committed
    STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep "^dbt-airflow-lib/" || true)

    if [ -z "$STAGED_FILES" ]; then
        echo -e "${YELLOW}⚠ No dbt-airflow-lib files in commit, skipping checks${NC}"
        exit 0
    fi

    check_project_root

    # Always clean artifacts
    clean_artifacts

    # Check if we should skip quality checks (for quick commits)
    if [ "$SKIP_PRE_COMMIT" = "1" ]; then
        echo -e "${YELLOW}Skipping quality checks (SKIP_PRE_COMMIT=1)${NC}"
        exit 0
    fi

    # Run quality checks
    run_formatting
    run_linting
    run_type_checking
    run_tests
    validate_yaml

    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${GREEN}✓ All pre-commit checks passed!${NC}"
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
}

# Run main function
main "$@"
